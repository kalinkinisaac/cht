name: CHT Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  api-tests:
    name: API Tests (Docker ClickHouse)
    runs-on: ubuntu-latest
    
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:23.8
        ports:
          - 8123:8123
          - 9000:9000
        env:
          CLICKHOUSE_USER: developer
          CLICKHOUSE_PASSWORD: developer
          CLICKHOUSE_DB: default
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
      
      - name: Wait for ClickHouse
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8123/ping; then
              echo "ClickHouse is ready"
              break
            fi
            echo "Waiting for ClickHouse... ($i/30)"
            sleep 2
          done
      
      - name: Run API tests
        run: |
          python scripts/run_tests.py api --verbose --coverage
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  unit-tests:
    name: Unit Tests (No Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
      
      - name: Run unit tests
        run: |
          python scripts/run_tests.py unit --verbose

  frontend-tests:
    name: Frontend Tests (Selenium)
    runs-on: ubuntu-latest
    
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:23.8
        ports:
          - 8123:8123
        env:
          CLICKHOUSE_USER: developer
          CLICKHOUSE_PASSWORD: developer
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test,ui-test]"
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Wait for ClickHouse
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8123/ping; then
              echo "ClickHouse is ready"
              break
            fi
            echo "Waiting for ClickHouse... ($i/30)"
            sleep 2
          done
      
      - name: Run frontend tests
        run: |
          python scripts/run_tests.py frontend --verbose
      
      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: frontend-test-artifacts
          path: |
            screenshots/
            logs/

  security-tests:
    name: Security & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install bandit safety
      
      - name: Run security checks
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          safety check --json --output safety-report.json || true
      
      - name: Run code quality checks
        run: |
          black --check src/ tests/
          isort --check-only src/ tests/
          flake8 src/ tests/
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  build-test:
    name: Build & Distribution Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Test package installation
        run: |
          pip install dist/*.whl
          python -c "import cht; print('Package installed successfully')"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-package
          path: dist/